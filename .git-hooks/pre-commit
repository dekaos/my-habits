#!/bin/bash
# Pre-commit hook to remind about release testing
# To enable this hook, rename this file to 'pre-commit' (remove .sample)
# and make it executable: chmod +x .git/hooks/pre-commit

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo ""
echo -e "${YELLOW}üîç Pre-commit checks...${NC}"
echo ""

# Check if any Dart files are being committed
DART_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.dart$')

if [ -z "$DART_FILES" ]; then
    echo -e "${GREEN}‚úÖ No Dart files to check${NC}"
    exit 0
fi

echo "üìù Checking Dart files..."

# Run Flutter analyze
echo "Running flutter analyze..."
if ! flutter analyze; then
    echo -e "${RED}‚ùå Flutter analyze found issues. Please fix them before committing.${NC}"
    exit 1
fi

# Run Flutter format check
echo "Checking code formatting..."
if ! flutter format --set-exit-if-changed --dry-run $DART_FILES > /dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  Code formatting issues detected.${NC}"
    echo "Run 'flutter format .' to fix formatting."
    echo ""
    read -p "Do you want to auto-format now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        flutter format $DART_FILES
        echo -e "${GREEN}‚úÖ Files formatted. Please stage the changes and commit again.${NC}"
        exit 1
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Continuing with unformatted code...${NC}"
    fi
fi

# Check for common issues
echo "Checking for common issues..."

# Check for debugPrint (should use debugPrint instead of print)
if echo "$DART_FILES" | xargs grep -n "print(" 2>/dev/null | grep -v "debugPrint"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found print() statements. Consider using debugPrint() instead.${NC}"
fi

# Check for TODO comments
if echo "$DART_FILES" | xargs grep -n "TODO" 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Found TODO comments. Please address them before production.${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ Pre-commit checks passed!${NC}"
echo ""

# Reminder about release testing
if [ -f "lib/services/notification_service.dart" ] || \
   [ -f "lib/services/background_service.dart" ] || \
   echo "$DART_FILES" | grep -q "service"; then
    echo -e "${YELLOW}‚ö†Ô∏è  REMINDER: You're modifying service files!${NC}"
    echo ""
    echo "Services may behave differently in release builds due to ProGuard."
    echo "Please test in release mode before pushing:"
    echo ""
    echo "  ./scripts/quick_release_test.sh"
    echo ""
    read -p "Have you tested this in release mode? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  Please test in release mode before pushing to production!${NC}"
        echo ""
        echo "To test now, run:"
        echo "  ./scripts/quick_release_test.sh"
        echo ""
        read -p "Continue with commit anyway? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

echo -e "${GREEN}‚úÖ Ready to commit!${NC}"
echo ""

exit 0

